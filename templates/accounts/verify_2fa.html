{% extends "base_auth.html" %}
{% load static i18n %}

{% block title %}{% trans "Verify Two-Factor Authentication" %}{% endblock %}

{% block auth_title %}{% trans "Two-Factor Authentication" %}{% endblock %}
{% block auth_subtitle %}{% trans "Enter your verification code" %}{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <div class="verification-icon mb-3">
        <i class="bi bi-shield-lock text-primary" style="font-size: 3rem;"></i>
    </div>
    <h3>{% trans "Verify Your Identity" %}</h3>
    <p class="text-muted">
        {% trans "Enter the 6-digit code from your authenticator app" %}
    </p>
</div>

<form method="post" action="{% url 'mfa_authenticate' %}" class="needs-validation" novalidate>
    {% csrf_token %}

    <div class="mb-4">
        <label for="id_code" class="form-label visually-hidden">
            {% trans "Verification Code" %}
        </label>
        <input type="text"
               class="form-control form-control-lg text-center verification-code-input"
               id="id_code"
               name="code"
               pattern="[0-9]{6}"
               maxlength="6"
               placeholder="000000"
               required
               autocomplete="off"
               autofocus>
        <div class="invalid-feedback text-center">
            {% trans "Please enter a valid 6-digit code" %}
        </div>
        <div class="form-text text-center">
            {% trans "The code changes every 30 seconds" %}
        </div>
    </div>

    {% if redirect_field_value %}
    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}">
    {% endif %}

    <div class="d-grid gap-2 mb-3">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-2"></i>
            {% trans "Verify Code" %}
        </button>
    </div>

    <div class="text-center">
        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#backupCodeModal">
            {% trans "Use a backup code instead" %}
        </a>
    </div>

</form>

<div class="alert alert-warning mt-4" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <small>
        {% trans "Lost access to your authenticator app? Contact your system administrator for assistance." %}
    </small>
</div>

<!-- Backup Code Modal -->
<div class="modal fade" id="backupCodeModal" tabindex="-1" aria-labelledby="backupCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupCodeModalLabel">
                    <i class="bi bi-key me-2"></i>
                    {% trans "Use Backup Code" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'mfa_authenticate_backup' %}">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="id_backup_code" class="form-label">
                            {% trans "Enter one of your backup codes:" %}
                        </label>
                        <input type="text"
                               class="form-control"
                               id="id_backup_code"
                               name="backup_code"
                               placeholder="XXXX-XXXX-XXXX"
                               required
                               autocomplete="off">
                        <div class="form-text">
                            {% trans "Each backup code can only be used once" %}
                        </div>
                    </div>

                    {% if redirect_field_value %}
                    <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}">
                    {% endif %}

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            {% trans "Verify Backup Code" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Auto-format verification code input
const codeInput = document.getElementById('id_code');
codeInput.addEventListener('input', function(e) {
    // Only allow numbers
    this.value = this.value.replace(/[^0-9]/g, '');
});

// Auto-submit form when 6 digits are entered
codeInput.addEventListener('input', function(e) {
    if (this.value.length === 6) {
        // Optional: Auto-submit after a short delay
        // setTimeout(() => this.form.submit(), 300);
    }
});

// Form validation
(function() {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');

    Array.from(forms).forEach(function(form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();
</script>
{% endblock %}
