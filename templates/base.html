{% load static i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="{% block meta_description %}{{ tenant.name }} - Modern School Management System{% endblock %}">
    <meta name="author" content="{{ tenant.name }}">

    <title>{% block title %}{{ tenant.name }}{% endblock %} | School Management</title>

    <!-- Favicon -->
    {% if tenant.logo %}
    <link rel="icon" type="image/png" href="{{ tenant.logo.url }}">
    {% else %}
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    {% endif %}

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {% block extra_css %}{% endblock %}

    <!-- HTMX for dynamic interactions -->
    <script src="{% static 'js/htmx.min.js' %}" defer></script>
</head>
<body class="{% block body_class %}{% endblock %}">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{% trans "Loading..." %}</span>
        </div>
    </div>

    <!-- Navigation -->
    {% block navigation %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'dashboard' %}">
                {% if tenant.logo %}
                <img src="{{ tenant.logo.url }}" alt="{{ tenant.name }}" height="40" class="me-2">
                {% else %}
                <i class="bi bi-mortarboard-fill fs-3 me-2"></i>
                {% endif %}
                <span class="fw-bold">{{ tenant.name }}</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="{% trans 'Toggle navigation' %}">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-lg-center">
                    {% if user.is_authenticated %}

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}">
                            <i class="bi bi-speedometer2 me-1"></i>
                            {% trans "Dashboard" %}
                        </a>
                    </li>

                    {% if user.role == 'direction' or user.role == 'admin' %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="managementDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear me-1"></i>
                            {% trans "Management" %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="managementDropdown">
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-people"></i> {% trans "Students" %}
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-person-badge"></i> {% trans "Professors" %}
                            </a></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-book"></i> {% trans "Courses" %}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">
                                <i class="bi bi-bar-chart"></i> {% trans "Monitoring" %}
                            </a></li>
                        </ul>
                    </li>
                    {% endif %}

                    {% if user.role == 'professor' %}
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-calendar-check me-1"></i>
                            {% trans "Attendance" %}
                        </a>
                    </li>
                    {% endif %}

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="notificationsDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell position-relative">
                                {% if unread_notifications_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    {{ unread_notifications_count }}
                                    <span class="visually-hidden">{% trans "unread notifications" %}</span>
                                </span>
                                {% endif %}
                            </i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notifications-dropdown" aria-labelledby="notificationsDropdown">
                            <li class="dropdown-header">{% trans "Notifications" %}</li>
                            {% if notifications %}
                                {% for notification in notifications %}
                                <li>
                                    <a class="dropdown-item {% if not notification.read %}fw-bold{% endif %}"
                                       href="{{ notification.url }}">
                                        <small class="text-muted">{{ notification.created_at|timesince }}</small><br>
                                        {{ notification.message|truncatewords:10 }}
                                    </a>
                                </li>
                                {% endfor %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-center text-primary" href="#">
                                    {% trans "View all notifications" %}
                                </a></li>
                            {% else %}
                                <li><span class="dropdown-item-text text-muted">{% trans "No notifications" %}</span></li>
                            {% endif %}
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown"
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="{{ user.get_full_name }}"
                                 class="rounded-circle me-2" width="32" height="32">
                            {% else %}
                            <div class="avatar-placeholder me-2">
                                <span>{{ user.first_name.0|upper }}{{ user.last_name.0|upper }}</span>
                            </div>
                            {% endif %}
                            <span class="d-none d-lg-inline">{{ user.get_full_name }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="profileDropdown">
                            <li class="dropdown-header">
                                {{ user.get_full_name }}<br>
                                <small class="text-muted">{{ user.get_role_display }}</small>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{% url 'profile' %}">
                                <i class="bi bi-person"></i> {% trans "My Profile" %}
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'account_change_password' %}">
                                <i class="bi bi-key"></i> {% trans "Change Password" %}
                            </a></li>
                            {% if user.role in roles_requiring_2fa %}
                            <li><a class="dropdown-item" href="{% url 'mfa_index' %}">
                                <i class="bi bi-shield-check"></i> {% trans "Two-Factor Auth" %}
                            </a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form method="post" action="{% url 'account_logout' %}">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right"></i> {% trans "Logout" %}
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>

                    {% else %}

                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'account_login' %}">
                            <i class="bi bi-box-arrow-in-right me-1"></i>
                            {% trans "Login" %}
                        </a>
                    </li>

                    {% endif %}

                    <!-- Language Selector -->
                    <li class="nav-item dropdown ms-lg-2">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-globe"></i>
                            <span class="d-lg-none ms-1">{% trans "Language" %}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                            {% get_available_languages as languages %}
                            {% for lang_code, lang_name in languages %}
                            <li>
                                <form action="{% url 'set_language' %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="language" value="{{ lang_code }}">
                                    <button type="submit" class="dropdown-item {% if lang_code == LANGUAGE_CODE %}active{% endif %}">
                                        {{ lang_name }}
                                    </button>
                                </form>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endblock navigation %}

    <!-- Main Content -->
    <main id="main-content" class="{% block main_class %}container-fluid py-4{% endblock %}">
        {% block messages %}
        {% if messages %}
        <div class="container">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{% trans 'Close' %}"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endblock messages %}

        {% block content %}
        <!-- Page content goes here -->
        {% endblock content %}
    </main>

    <!-- Footer -->
    {% block footer %}
    <footer class="footer mt-auto py-4 bg-light">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5>{{ tenant.name }}</h5>
                    <p class="text-muted">{{ tenant.description|default:"Modern School Management System" }}</p>
                </div>
                <div class="col-md-4 mb-3 mb-md-0">
                    <h5>{% trans "Quick Links" %}</h5>
                    <ul class="list-unstyled">
                        <li><a href="{% url 'dashboard' %}" class="text-decoration-none">{% trans "Dashboard" %}</a></li>
                        <li><a href="{% url 'privacy' %}" class="text-decoration-none">{% trans "Privacy Policy" %}</a></li>
                        <li><a href="{% url 'terms' %}" class="text-decoration-none">{% trans "Terms of Service" %}</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>{% trans "Contact" %}</h5>
                    <ul class="list-unstyled">
                        {% if tenant.email %}
                        <li><i class="bi bi-envelope me-2"></i>{{ tenant.email }}</li>
                        {% endif %}
                        {% if tenant.phone %}
                        <li><i class="bi bi-telephone me-2"></i>{{ tenant.phone }}</li>
                        {% endif %}
                        {% if tenant.address %}
                        <li><i class="bi bi-geo-alt me-2"></i>{{ tenant.address }}</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            <hr>
            <div class="text-center text-muted">
                <p class="mb-0">&copy; {% now "Y" %} {{ tenant.name }}. {% trans "All rights reserved." %}</p>
                <p class="mb-0"><small>{% trans "Powered by School Management System" %}</small></p>
            </div>
        </div>
    </footer>
    {% endblock footer %}

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- Custom JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>

    {% block extra_js %}{% endblock %}

</body>
</html>
